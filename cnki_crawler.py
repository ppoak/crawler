import requests
import urllib
import os
import pandas as pd
from lxml import etree

keyword = "神经网络"
page = 12
url = "https://kns.cnki.net/KNS8/Brief/GetGridTableHtml"
headers = {
    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
    "Accept": "text/html, */*; q=0.01",
    "Accept-Language": "zh-cn",
    "Accept-Encoding": "gzip, deflate, br",
    "Host": "kns.cnki.net",
    "Origin": "https://kns.cnki.net",
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Safari/605.1.15",
    "Connection": "keep-alive",
    "Referer": "https://kns.cnki.net/kns8/defaultresult/index",
    "Content-Length": "948",
    "Cookie": r"_pk_id=d45e0759-9a57-4d99-873e-238345154f5e.1632660741.11.1633176590.1633173780.; _pk_ses=*; CurrSortField=%e5%8f%91%e8%a1%a8%e6%97%b6%e9%97%b4%2f(%e5%8f%91%e8%a1%a8%e6%97%b6%e9%97%b4%2c%27TIME%27); CurrSortFieldType=desc; dSearchFold=undefined; dperpage=20; dsorder=pubdate; dstyle=listmode; dversion=undefined; knsLeftGroupSelectItem=; language=undefined; searchTimeFlag=0; showlist=CJFQ%2CCDMD%2CCIPD%2CCCND%2CBDZK%2CCISD%2CSNAD%2CCCJD%2CGXDB_SECTION%2CCJFN%2CCCVD%2CCLKLK%2C1633176385537; Ecp_loginuserbk=sh0301; Ecp_session=1; SID_kns=025123114; SID_klogin=125141; SID_kvisual=125105; Ecp_ClientId=6210601193101184315; SID_krsnew=125134; SID_kxreader_new=011121; yeswholedownload=%3Bhbjr202109013; SID_kcms=124115; Ecp_IpLoginFail=21092949.77.147.157; Ecp_ClientIp=49.77.147.157; SID_kns_new=kns123110; ASP.NET_SessionId=gvufzaeqj1tfkdqfvhgn4lo3; SID_kns8=123122; UM_distinctid=17c24ac48c57d5-06bb1faa9fadd5-3e62684b-13c680-17c24ac48c6e28; cnkiUserKey=49e5aa07-7a8f-6bc6-74a6-f11a20f039c8",
    "X-Requested-With": "XMLHttpRequest"
}
data = {
    "IsSearch": 'true',
    "QueryJson": '{"Platform":"","DBCode":"SCDB","KuaKuCode":"CJFQ,CDMD,CIPD,CCND,BDZK,CISD,SNAD,CCJD,GXDB_SECTION,CJFN,CCVD,CLKLK","QNode":{"QGroup":[{"Key":"Subject","Title":"","Logic":1,"Items":[{"Title":"主题","Name":"SU","Value":"' + f'{keyword}' + '","Operate":"%=","BlurType":""}],"ChildItems":[]}]}}',
    "PageName": 'DefaultResult',
    "DBCode": 'SCDB',
    "KuaKuCodes": 'CJFQ,CDMD,CIPD,CCND,BDZK,CISD,SNAD,CCJD,GXDB_SECTION,CJFN,CCVD,CLKLK',
    "SearchSql": "0645419CC2F0B23B6FB4D0AB545BB6A10F52D5CCFDFDD99C31A10DA18FD80144D2EF43210627931EB0A141AA7696B3C5A507BA29BFC0A8AB0E83356882BC16D58412057A3590348EFB17F59906BE83D02CBDD98ED44FC6A6B88BA1DCB9C7E41ACB3D35FA475928DF32CA1A52E50C17E0B9858EB1BA7E5A95A1CF8CFA02FC4DFDA3BCFA4054E093715245C6124C1E5B99FAF581C91A88CDFDAEF99820D9F336184F8D2D7C14BBDB9B00DA1D3BC0ACF8FEECC3A36F69285DCB820B55EEACFF0E7A92A93FCE29484C0F72287C7C8D244888BF2C15197763E0A57C96D2C337E8F1FA6B13C4BC12D9EACFCC2F665891D5A1CD2F8EACA7B812D9FA010CE2246C12B7B5C7824CCF6EE3F66B8E8C63762E5B43A3877130B6D62E3BA4C97297CB9A236939A6249601D99ACC46D5A8F1803D80E2C6CB5CD69E670A61AE3E4D790C2420125CB30381E5DD2B3BCF5070D0B056D0C702A8B7968B6FE4E00873767495FDF9CE0209B57E86B04942B9238FA7180FB8D5FD6B410D3327DCD67E34460B86111393AF0BC6AEFB5231AF68C8C92EA19A3D9AA445C3C26318E2FEC0CACE3588052E15D81F7B63F765836A0541DFCA8D60636F07B53F55E52ABD9FB083A2DE0812B9CC7A85329AF4EC682323F50918E13031CFEDF5A75E0C361D50F5DB1837542D8FF58E8DA7656BA440ED8598E0D1D06BA38523285F26F811B5841355D980D74D7AFC7170E6978209E9F30765B930D02750A470D3B6B9165A4C2DED5E4E984CD76EE46164D9C4D1CCFBCC5A153843A692DB26A9C742F2ED3E8A2E2EA8179E4B66DE36A7D9D87E6CEE14C01733D1CDE98D0979CDB05355395E9F193B493CDB2B3B8DB09CD8B5D10D921D78799E42525DE78E62630F522571AAB890D3859B4BE90CA32C45B760646EB8BA087E0EBE2866C4EBD04EA08B72B670146B691F7AD98E746AEB52C10C817D87B96CE81510BD0BFBF61E7C257E521F434F1078920D714EBC1B9AE9EECD181031C8EBFF83DFA0A56A89B84F0575EFD8CE379F3EFFD25E08448954186D8DF2FF9307480935CFC03E3C5934AD3F4D4DC85A95688317C7CDFA5BB025E7F14E6262BC0372CEB92A57DE20EA3F77019EDFC894E390FC2D2F0336EDD72E6FC3491454FDA0D0DE423CD7315904A756FEF3DFDA9CC0C08AF9CBBFD72582C9020A3271B6014E7A2071F0DCD74F558E3A14F6DB40E66646124D8901FEFB01A79779A27BABC87DA17A5E871BACD7A845063C3C002CAFC3A197EC2A88CF2E6EA76F6F5D077D21BFB7DB3BCAE5726889BBEE3C08A7216D9688AE34D95F45D411EEB426F07CC11B6518E723AE9BEA78505D980FE62F3F33FE42B66C69D0DFD290C7B14EEDCA59096815E33D8A250F529C57CB65277B740312DB3C37985AB97C0C173FCF67EC199966AF3B13BCE89CD888732B165A21CD34C26A1C6FB379772E7743138A658F43B9DAFD930EDAF378E61DACF92461B786108DB2E33AB8AB1F588AD8FA89CD865D7ACCBE0175EA493ABB76F9BCAD35F0113CA7893E2DA39DA06A6A3ABC7448D2E7493DB8E431E5792C790FD14A6325C16BF8E02489615B1A5347C42EE5FF8CEDC1A6C145B4E9279EAC6BB82797D89484B9CEF61273CDD946065CE44F099DB3B0E5E970B918F200BFF6FC29423272BDDBE657EB47E86F85E55D7FC2C2000295A43ECDC43F4614D625DA3B50205CF3154A2AF7A823328DDFA02521B9C74B2193900C80D1727A3643CC56CADD5248F0C0D0DC6D62820F43D3345A617D3DEB2EE0129298E2ACC539EE417E1163838E88432DC5D73FFE96C15CC28974C6B697C57596DEF0D2EC23CFB7834D0B626EFF0D1861DC4EB7684CBAD4669B9122F6AAA4CC15ACF2682311CC43EBD4C2D50D2E076AB0D18EC5D364DFBC4606B6DF49865433580B1B28DE7C2E207D5CA21E3B6691ECB2E055AF130065C4224E97C1D9FE24BB95DA80D83995FEF707C390E12215573374769C11F5B17993ADC053466BDBA4072E37C3AAF3AE312835615144425BDF2BC55FEF04B7A7EFE08757023B83333A8C520B3B03437500AA78AAEB8FDE5DF342EEE8C50B3EE25E53C65F7479CCE7C1599479105214C740A1C4437900353C6A97DDA80E06153BA83A1AA9F7E3C7238CC446A8AD51F75BEB00B607E5216EA3C041A9939711D5EDB2D136AB42FF94689B988CD9EC60603BF1BB55FF6CBCA0893778A9A3F82832911CF9B62FE578B416DA90E7B241F939DEF1642193BB210071F00E800BAB04EBEBA1D2F25C360902E29BC9E4D7C32FF0F6E5C47D9055905994787E22CD29355FD04138178FB0A10924682E77CFE71255389BA55C69345F8F9DA139FA372F11F8F0117BD4320694C4D0A12EDBCE235731D26DF91D86EACA91D687B3D40066F7FC22CDCD4CEA7EB31BAEAFAF924DB52F1DE685F5E0D8684326D0F67D0CD6D7F1A140735A5A72C7AB852D3FCD238A5FDECBAC511F73797861D013825FD27B286557E0D0BE6209AE4237A0A9F66C7EE88D8C58BEEAE601B2FD489DA77F95273C14730649887206FE74733852033E9559AE81794087B2870CBDD51879C5C5A42CFD3AC0B8D961FB65E13041AF2180330CE124626AB5090EEA5F23693CC6CF9B6A77AA7A550351BE85892972C685BBD2AC59B3D7F98A63A307A3BD458EAA7C35D8E4E84C21D5DF3DC20DF442A2F98D2E93F18A761C109275262CA42558B1A78545F4629EECEA5D7597D6FB7327D468E1768CE524705DCCC7F748BDAF42CBA045FDA26BEC8E10B0FB02B5768B129F1F0E0622CC90947736E79CC10BC86FEF309736BAD37BB688F15857AAB2366D1DBB5E80DE691273CB5A052B525E83D6E4A748FE69AA53C9B4ED85AEAD5B2C0AD2A73F6B805B02298D55158379401A5814D1AA24776D9E36E57A46291DC99A415CD4AC466FEC301BE7E49D8E1F19C24E29CBC27D731FA59A857D5A27D1F83A12567D2D741118338A87FB40C4069A532DE37469B89416C520A236BBB57E426AACD03395E036411C8348BDD0BE7EAB89555753BFAB6A854B83E88B5DE15DA54CBC6C1D313875B33248B8699A28AD37C83D896A3042913F78A9FA6105D5CA410543D6109C306609663B3632598AD41FCAE5BDEF9B9A72EBC5696FD2FC33265CB6A2EB809DCA4CBF9805CBCDEA3DB560F151F49CA90D104A089ED8A704EAF5D2FEABE0D90822B99C6F86137024C3B315329CA2073B642C8B04B613B7838D3CDCB28B870D169D6E21D26A780966BB7458301305CCF685D3E18D14A3944CF071E55C",
    "CurPage": f'{page}',
    "RecordsCntPerPage": '20',
    "CurDisplayMode": 'listmode',
    "CurrSortField": r'%e5%8f%91%e8%a1%a8%e6%97%b6%e9%97%b4%2f(%e5%8f%91%e8%a1%a8%e6%97%b6%e9%97%b4%2c%27TIME%27)',
    "CurrSortFieldType": 'desc',
    "IsSentenceSearch": 'false',
    "Subject": '',
}

res = requests.post(url, data=data, headers=headers)
with open("tmp.html", 'w') as f:
    f.write(res.text)
result = pd.read_html("tmp.html", encoding='utf8')[0]
result.to_csv("result.csv", encoding="utf-8", index=False)
os.remove("tmp.html")
print(result["题名"])